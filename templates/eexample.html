<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiple File Upload with Parameters</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .stopwatch {
            margin-top: 10px;
            font-size: 1.2em;
            color: #333;
        }
        .message {
            margin-top: 10px;
            color: green;
        }
    </style>
    <script>
        let stopwatchInterval;
        let elapsedTime = 0;

        function startStopwatch() {
            elapsedTime = 0;
            const stopwatchDisplay = document.getElementById('stopwatch');
            stopwatchDisplay.textContent = `Elapsed Time: 0 seconds`;

            stopwatchInterval = setInterval(() => {
                elapsedTime++;
                stopwatchDisplay.textContent = `Elapsed Time: ${elapsedTime} seconds`;
            }, 1000);
        }

        function stopStopwatch() {
            clearInterval(stopwatchInterval);
        }

        async function uploadChunk(chunk, fileName, chunkNumber, totalChunks) {
            const formData = new FormData();
            formData.append('file', chunk);
            formData.append('filename', fileName);
            formData.append('chunkNumber', chunkNumber);
            formData.append('totalChunks', totalChunks);

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Failed to upload chunk ${chunkNumber} of file ${fileName}.`);
            }

            return await response.text();
        }

        async function handleFileUpload(file) {
            const chunkSize = 2 * 1024 * 1024; // 2MB
            const totalChunks = Math.ceil(file.size / chunkSize);
            const fileName = file.name;
            const chunks = [];

            for (let i = 0; i < totalChunks; i++) {
                const start = i * chunkSize;
                const end = Math.min(start + chunkSize, file.size);
                const chunk = file.slice(start, end);

                chunks.push(() => uploadChunk(chunk, fileName, i + 1, totalChunks));
            }

            return chunks;
        }

        async function uploadChunksInBatches(chunks, batchSize) {
            for (let i = 0; i < chunks.length; i += batchSize) {
                const batch = chunks.slice(i, i + batchSize).map(fn => fn());
                await Promise.all(batch);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const fileInput = document.getElementById('file');
            const files = Array.from(fileInput.files);

            if (files.length === 0) {
                document.getElementById('message').textContent = 'Please select files to upload.';
                return;
            }

            startStopwatch();

            try {
                const allChunks = [];
                for (const file of files) {
                    const chunks = await handleFileUpload(file);
                    allChunks.push(...chunks);
                }

                await uploadChunksInBatches(allChunks, 4); // Upload 4 chunks at a time

                stopStopwatch();
                document.getElementById('message').textContent = 'All files uploaded successfully!';
            } catch (error) {
                stopStopwatch();
                document.getElementById('message').textContent = `Error: ${error.message}`;
            }
        }
    </script>
</head>
<body>
    <h1>Multiple File Upload with Parameters</h1>
    <form id="uploadForm" onsubmit="handleSubmit(event)">
        <label for="file">Choose files to upload:</label>
        <input type="file" id="file" name="file" multiple required>
        <button type="submit">Upload</button>
    </form>

    <div class="stopwatch" id="stopwatch">Elapsed Time: 0 seconds</div>
    <div class="message" id="message"></div>
</body>
</html>